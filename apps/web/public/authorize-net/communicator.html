<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authorize.Net Payment Communicator</title>
    <meta name="robots" content="noindex, nofollow">
</head>
<body>
    <script>
    /**
     * Authorize.Net Accept.js Communicator
     *
     * SECURITY CRITICAL:
     * - NO wildcard origins allowed
     * - Strict origin validation required
     * - Must validate exact domains
     */

    (function() {
        'use strict';

        // CRITICAL: Define allowed origins explicitly - NO WILDCARDS
        const ALLOWED_ORIGINS = [
            // Production domains
            'https://tooly.com',
            'https://www.tooly.com',
            'https://shop.tooly.com',
            'https://peptides.com',
            'https://www.peptides.com',
            'https://shop.peptides.com',

            // Staging domains (if needed)
            'https://staging.tooly.com',
            'https://staging.peptides.com',

            // Development (only if explicitly needed)
            // Remove in production builds
            ...(process.env.NODE_ENV === 'development' ? [
                'http://localhost:3000',
                'http://localhost:3001',
                'http://127.0.0.1:3000'
            ] : [])
        ];

        // Authorize.Net API endpoints
        const AUTHORIZENET_ORIGINS = [
            'https://accept.authorize.net',
            'https://test.authorize.net',
            'https://api.authorize.net',
            'https://api2.authorize.net'
        ];

        // Combined allowed origins
        const ALL_ALLOWED_ORIGINS = [...ALLOWED_ORIGINS, ...AUTHORIZENET_ORIGINS];

        /**
         * Validate origin against allowed list
         * @param {string} origin - Origin to validate
         * @returns {boolean} - True if origin is allowed
         */
        function isOriginAllowed(origin) {
            if (!origin) {
                console.error('[AuthorizeNet] No origin provided');
                return false;
            }

            // CRITICAL: Exact match only - no wildcards, no regex
            const isAllowed = ALL_ALLOWED_ORIGINS.includes(origin);

            if (!isAllowed) {
                console.error(`[AuthorizeNet] Origin not allowed: ${origin}`);
                console.error('[AuthorizeNet] Allowed origins:', ALL_ALLOWED_ORIGINS);
            }

            return isAllowed;
        }

        /**
         * Handle postMessage events
         */
        window.addEventListener('message', function(event) {
            // CRITICAL: Validate origin first
            if (!isOriginAllowed(event.origin)) {
                console.error('[AuthorizeNet] Rejected message from unauthorized origin:', event.origin);
                return;
            }

            // Log for debugging (remove in production)
            if (process.env.NODE_ENV === 'development') {
                console.log('[AuthorizeNet] Received message from:', event.origin);
                console.log('[AuthorizeNet] Message data:', event.data);
            }

            // Handle Authorize.Net messages
            if (event.origin.includes('authorize.net')) {
                handleAuthorizeNetMessage(event);
            }
            // Handle app messages
            else if (ALLOWED_ORIGINS.includes(event.origin)) {
                handleAppMessage(event);
            }
        });

        /**
         * Handle messages from Authorize.Net
         */
        function handleAuthorizeNetMessage(event) {
            try {
                const message = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;

                // Forward to parent window (our app)
                if (window.parent && window.parent !== window) {
                    // Find the app origin
                    const appOrigin = ALLOWED_ORIGINS.find(origin =>
                        document.referrer.startsWith(origin)
                    );

                    if (appOrigin) {
                        window.parent.postMessage(message, appOrigin);
                    } else {
                        console.error('[AuthorizeNet] Could not determine app origin');
                    }
                }
            } catch (error) {
                console.error('[AuthorizeNet] Error handling Authorize.Net message:', error);
            }
        }

        /**
         * Handle messages from our app
         */
        function handleAppMessage(event) {
            try {
                const message = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;

                // Forward to Authorize.Net if needed
                if (message.action === 'tokenize') {
                    // This would communicate with Authorize.Net Accept.js
                    // Implementation depends on your specific Authorize.Net integration
                    console.log('[AuthorizeNet] Tokenization requested');
                }
            } catch (error) {
                console.error('[AuthorizeNet] Error handling app message:', error);
            }
        }

        // Security headers check (for debugging)
        if (process.env.NODE_ENV === 'development') {
            console.log('[AuthorizeNet] Communicator loaded');
            console.log('[AuthorizeNet] Document referrer:', document.referrer);
            console.log('[AuthorizeNet] Window location:', window.location.href);
        }
    })();
    </script>

    <!-- Authorize.Net Accept.js -->
    <script type="text/javascript"
            src="https://js.authorize.net/v1/Accept.js"
            charset="utf-8">
    </script>

    <noscript>
        <p>JavaScript is required for payment processing.</p>
    </noscript>
</body>
</html>